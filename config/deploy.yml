# Kamal 2 deployment configuration
# Default: Staging environment
# For production: kamal deploy -d production

service: wordle-group

image: onpequod/wordlegroup

servers:
  web:
    hosts:
      - staging.hatchery.lan
    options:
      add-host: host.docker.internal:host-gateway
  job:
    hosts:
      - staging.hatchery.lan
    cmd: php artisan horizon
    options:
      add-host: host.docker.internal:host-gateway

proxy:
  ssl: false
  host: wordlegroup.pequod.sh
  app_port: 80
  healthcheck:
    path: /health
    interval: 5
    timeout: 30

ssh:
  user: deploy
  keys:
    - ~/.ssh/scv

registry:
  server: ghcr.io
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

builder:
  dockerfile: docker/production/Dockerfile
  context: .
  arch: amd64

env:
  clear:
    APP_NAME: "Wordle Group"
    APP_ENV: staging
    APP_DEBUG: "true"
    APP_URL: https://wordlegroup.pequod.sh
    LOG_CHANNEL: stack
    LOG_LEVEL: debug
    DB_CONNECTION: mysql
    DB_HOST: host.docker.internal
    DB_PORT: 3306
    DB_DATABASE: wordlegroup_staging
    REDIS_HOST: host.docker.internal
    REDIS_PORT: 6379
    CACHE_STORE: redis
    SESSION_DRIVER: redis
    SESSION_LIFETIME: 120
    QUEUE_CONNECTION: redis
    BROADCAST_DRIVER: log
    FILESYSTEM_DISK: local
    MAIL_MAILER: ses
    MAIL_FROM_ADDRESS: scores@wordlegroup.com
    MAIL_FROM_NAME: "Wordle Group"
    AWS_DEFAULT_REGION: us-east-1
    SENTRY_TRACES_SAMPLE_RATE: 0.05
  secret:
    - APP_KEY
    - DB_USERNAME
    - DB_PASSWORD
    - REDIS_PASSWORD
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY
    - SENTRY_LARAVEL_DSN

volumes:
  - /var/data/wordle-group/storage:/var/www/html/storage

# MySQL and Redis are provisioned on the host via Ansible
# Database must be created before first deploy:
#   CREATE DATABASE wordlegroup_staging;
#   CREATE USER 'wordlegroup'@'172.17.0.1' IDENTIFIED BY 'xxx';
#   GRANT ALL PRIVILEGES ON wordlegroup_staging.* TO 'wordlegroup'@'172.17.0.1';
