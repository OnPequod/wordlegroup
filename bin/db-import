#!/bin/bash
set -e

# Import SQL dump to staging database
# Usage: bin/db-import /path/to/wordlegroup.sql

SQL_FILE="${1}"
DATABASE="${2:-wordlegroup_staging}"

if [[ -z "$SQL_FILE" ]]; then
    echo "Usage: bin/db-import /path/to/wordlegroup.sql [database_name]"
    echo ""
    echo "Arguments:"
    echo "  sql_file     Path to the SQL dump file (required)"
    echo "  database     Target database (default: wordlegroup_staging)"
    exit 1
fi

if [[ ! -f "$SQL_FILE" ]]; then
    echo "Error: SQL file not found: $SQL_FILE"
    exit 1
fi

echo "==> Importing $SQL_FILE into $DATABASE on staging.hatchery.lan..."

# Copy the SQL file to the server and import
ssh -i ~/.ssh/scv deploy@staging.hatchery.lan "mkdir -p ~/tmp"
scp -i ~/.ssh/scv "$SQL_FILE" deploy@staging.hatchery.lan:~/tmp/import.sql

# Import using the MySQL container or host MySQL
ssh -i ~/.ssh/scv deploy@staging.hatchery.lan "mysql -u wordlegroup -p\$(cat ~/.kamal/apps/wordle-group/env/roles/web.env | grep DB_PASSWORD | cut -d= -f2) $DATABASE < ~/tmp/import.sql && rm ~/tmp/import.sql"

echo "==> Import complete!"
echo ""
echo "Post-import steps:"
echo "  1. Run migrations if needed: kamal app exec 'php artisan migrate'"
echo "  2. Clear caches: kamal app exec 'php artisan config:cache && php artisan route:cache'"
