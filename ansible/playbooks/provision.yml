---
# Provision wordle-group app on target server
# Creates database, user, and storage directories
#
# Usage:
#   cd ansible && ansible-playbook playbooks/provision.yml -i inventory/production.yml
#   cd ansible && ansible-playbook playbooks/provision.yml -i inventory/staging.yml

- name: Provision wordle-group application
  hosts: all
  become: true
  gather_facts: true

  vars_files:
    - ~/Projects/web-server-management/vault/secrets.yml
    - ../vault/secrets.yml

  tasks:
    # === Swap Configuration ===
    - name: Check if swap file exists
      ansible.builtin.stat:
        path: /swapfile
      register: swap_file

    - name: Create swap file
      ansible.builtin.command: fallocate -l 8G /swapfile
      when: not swap_file.stat.exists
      changed_when: true

    - name: Set swap file permissions
      ansible.builtin.file:
        path: /swapfile
        mode: "0600"
      when: not swap_file.stat.exists

    - name: Format swap file
      ansible.builtin.command: mkswap /swapfile
      when: not swap_file.stat.exists
      changed_when: true

    - name: Enable swap file
      ansible.builtin.command: swapon /swapfile
      when: not swap_file.stat.exists
      changed_when: true

    - name: Add swap to fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        line: "/swapfile none swap sw 0 0"
        state: present

    # === Erik User (admin access) ===
    - name: Create erik user
      ansible.builtin.user:
        name: erik
        shell: /bin/bash
        groups: sudo,docker
        append: true
        state: present

    - name: Add SSH key for erik
      ansible.posix.authorized_key:
        user: erik
        key: "{{ lookup('file', '~/.ssh/erik.pub') }}"
        state: present

    - name: Allow erik passwordless sudo
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/erik
        line: "erik ALL=(ALL) NOPASSWD:ALL"
        create: true
        mode: "0440"
        validate: "visudo -cf %s"

    # === Autoheal (restarts unhealthy containers) ===
    - name: Start autoheal container
      community.docker.docker_container:
        name: autoheal
        image: willfarrell/autoheal:latest
        state: started
        restart_policy: always
        env:
          AUTOHEAL_CONTAINER_LABEL: all
          AUTOHEAL_INTERVAL: "60"
          AUTOHEAL_START_PERIOD: "120"
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock

    # === Application Setup ===
    - name: Create application directory
      ansible.builtin.file:
        path: "{{ web_root }}/{{ app_name }}"
        state: directory
        owner: deploy
        group: deploy
        mode: "0755"

    - name: Create storage directories (only persistent data - framework caches are container-local)
      ansible.builtin.file:
        path: "{{ web_root }}/{{ app_name }}/storage/{{ item }}"
        state: directory
        owner: deploy
        group: deploy
        mode: "0775"
      loop:
        - app
        - app/public
        - logs

    - name: Create Laravel log file
      ansible.builtin.file:
        path: "{{ web_root }}/{{ app_name }}/storage/logs/laravel.log"
        state: touch
        owner: deploy
        group: deploy
        mode: "0664"
      changed_when: false

    - name: Create application database
      community.mysql.mysql_db:
        name: "{{ db_name }}"
        state: present
        login_user: root
        login_password: "{{ mysql_root_password }}"

    - name: Create database user (Docker network access)
      community.mysql.mysql_user:
        name: "{{ db_user }}"
        password: "{{ db_password }}"
        host: "172.%"
        priv: "{{ db_name }}.*:ALL"
        state: present
        login_user: root
        login_password: "{{ mysql_root_password }}"

    - name: Create database user (localhost access)
      community.mysql.mysql_user:
        name: "{{ db_user }}"
        password: "{{ db_password }}"
        host: "localhost"
        priv: "{{ db_name }}.*:ALL"
        state: present
        login_user: root
        login_password: "{{ mysql_root_password }}"

    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          Wordle Group provisioned on {{ inventory_hostname }}!

          Storage: {{ web_root }}/{{ app_name }}/storage
          Database: {{ db_name }}
          DB User: {{ db_user }}

          Next: Generate secrets and deploy with Kamal
