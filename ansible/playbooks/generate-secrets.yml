---
# Generate .kamal/secrets for Kamal deployments
#
# Usage:
#   cd ansible && ansible-playbook playbooks/generate-secrets.yml

- name: Generate Kamal secrets
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - ~/Projects/web-server-management/vault/secrets.yml
    - ../vault/secrets.yml

  tasks:
    - name: Ensure .kamal directory exists
      ansible.builtin.file:
        path: "{{ playbook_dir }}/../../.kamal"
        state: directory
        mode: "0700"

    - name: Generate Kamal secrets file (secrets-common for all environments)
      ansible.builtin.template:
        src: ../templates/kamal-secrets.j2
        dest: "{{ playbook_dir }}/../../.kamal/secrets-common"
        mode: "0600"
      no_log: true

    - name: Display success message
      ansible.builtin.debug:
        msg: "Kamal secrets generated at .kamal/secrets-common"
